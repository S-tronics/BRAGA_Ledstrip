/**********************************************************************************************************************/
/**
 * @file        DrvTimer.c
 *
 * @author      Stijn Vermeersch
 * @date        15.05.2021
 *
 * @brief       
 *
 *
 * \n<hr>\n
 * Copyright (c) 2021, S-tronics\n
 * All rights reserved.
 * \n<hr>\n
 */
/**********************************************************************************************************************/

/**********************************************************************************************************************/



/***********************************************************************************************************************
; V E R I F Y    C O N F I G U R A T I O N
;---------------------------------------------------------------------------------------------------------------------*/

/**********************************************************************************************************************/



/***********************************************************************************************************************
; I N C L U D E S
;---------------------------------------------------------------------------------------------------------------------*/
#include "..\..\System\PIC16LF153x5\SysLibAll.h"
//DRIVER lib include section
#include "DrvTimer.h"
/**********************************************************************************************************************/



/***********************************************************************************************************************
; L O C A L   D E F I N I T I O N S   A N D   M A C R O S
;---------------------------------------------------------------------------------------------------------------------*/
/**********************************************************************************************************************/



/***********************************************************************************************************************
; L O C A L   T Y P E D E F S
;---------------------------------------------------------------------------------------------------------------------*/
/**********************************************************************************************************************/



/***********************************************************************************************************************
; L O C A L   F U N C T I O N   P R O T O T Y P E S
;---------------------------------------------------------------------------------------------------------------------*/
static void DrvTimerInitPeripheral(UNSIGNED_16 period);
/**********************************************************************************************************************/



/***********************************************************************************************************************
; L O C A L   V A R I A B L E S
;---------------------------------------------------------------------------------------------------------------------*/
static DRV_TIMER_HOOKISR hookisr;
/**********************************************************************************************************************/



/***********************************************************************************************************************
; E X P O R T E D   V A R I A B L E S
;---------------------------------------------------------------------------------------------------------------------*/

/**********************************************************************************************************************/



/***********************************************************************************************************************
; L O C A L   F U N C T I O N S
;---------------------------------------------------------------------------------------------------------------------*/
static void DrvTimerInitPeripheral(UNSIGNED_16 period)
{
    DOUBLE freq;
    
    //T0CON0 |= 0x10;                                 //16-bit enabled
    T0CON1 |= 0x40;                                 //Fosc/4 is timerclock 
    T0CON1 |= 0x0D;                                 //Prescaler 1:256
    
    freq = Get_PCLK() / 1000;                       //ms timer
    freq /= 8192;                                    //Prescaler 1:128
    freq /= 4;                                      //Fosc/4 is timerclock
    PR0 = ((DOUBLE)(period) * freq) - 1;          //Compare Register Timer0
    //TMR0H = ((UNSIGNED_16)((DOUBLE)(period) * freq) - 1) >> 8;
    //TMR0L = ((UNSIGNED_16)((DOUBLE)(period) * freq) - 1) & 0x00FF;
    
    
    T0CON0 |= 0x80;                                 //Enable Timer 0
    
}
/**********************************************************************************************************************/



/***********************************************************************************************************************
; E X P O R T E D   F U N C T I O N S
;---------------------------------------------------------------------------------------------------------------------*/
void DrvTimerInit(UNSIGNED_16 period, DRV_TIMER_HOOKISR isr)
{
	DrvTimerInitPeripheral(period);                //Every 100µs the timer 
    hookisr = isr;
}
/*--------------------------------------------------------------------------------------------------------------------*/
void DrvTimerIsr(void)
{
    hookisr();
    //T0CON0 |= 0x80;  
}
/*--------------------------------------------------------------------------------------------------------------------*/
void DrvTimerDisableInterrupt(void)
{
    //Timer2 Interrupt enable
    //PIE1 &= ~INT_TMR2IE;
}
/*--------------------------------------------------------------------------------------------------------------------*/
void DrvTimerEnableInterrupt(void)
{
    //Timer2 Interrupt enable
    //PIE1 |= INT_TMR2IE;
}
/**********************************************************************************************************************/

