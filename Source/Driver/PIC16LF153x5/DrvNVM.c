/**********************************************************************************************************************/
/**
 * @file        DrvNVM.c
 *
 * @author      Stijn Vermeersch
 * @date        18.07.2021
 *
 * @brief       
 *
 *
 * \n<hr>\n
 * Copyright (c) 2021, S-tronics\n
 * All rights reserved.
 * \n<hr>\n
 */
/**********************************************************************************************************************/

/**********************************************************************************************************************/



/***********************************************************************************************************************
; V E R I F Y    C O N F I G U R A T I O N
;---------------------------------------------------------------------------------------------------------------------*/

/**********************************************************************************************************************/



/***********************************************************************************************************************
; I N C L U D E S
;---------------------------------------------------------------------------------------------------------------------*/
#include "..\..\System\PIC16LF153x5\SysLibAll.h"
//DRIVER lib include section
#include "DrvNVM.h"
/**********************************************************************************************************************/



/***********************************************************************************************************************
; L O C A L   D E F I N I T I O N S   A N D   M A C R O S
;---------------------------------------------------------------------------------------------------------------------*/
#define INT_INTGIE  0x80        //Interrupt Global Enable
#define INT_PEIE    0x40        //Interrupt Periphery Enable
#define INT_INT0IE  0x10        //Interrupt External Interrupt INT0
/**********************************************************************************************************************/



/***********************************************************************************************************************
; L O C A L   T Y P E D E F S
;---------------------------------------------------------------------------------------------------------------------*/
/**********************************************************************************************************************/



/***********************************************************************************************************************
; L O C A L   F U N C T I O N   P R O T O T Y P E S
;---------------------------------------------------------------------------------------------------------------------*/

/**********************************************************************************************************************/



/***********************************************************************************************************************
; L O C A L   V A R I A B L E S
;---------------------------------------------------------------------------------------------------------------------*/

/**********************************************************************************************************************/



/***********************************************************************************************************************
; E X P O R T E D   V A R I A B L E S
;---------------------------------------------------------------------------------------------------------------------*/

/**********************************************************************************************************************/



/***********************************************************************************************************************
; L O C A L   F U N C T I O N S
;---------------------------------------------------------------------------------------------------------------------*/

/*--------------------------------------------------------------------------------------------------------------------*/
static void DrvNVM_unlock_sequence(void) {
    //Disable global interrupts                       
    INTCON &= ~INT_INTGIE; //Disable Global Interrupt
    //End disable global interrupts

    //Execute unlock sequence
    NVMCON2 = 0x55;
    NVMCON2 = 0xAA;
    NVMCON1bits.WR = 1;
    //End unlock sequence

    //Enable global interrupts
    INTCON |= INT_INTGIE; //Disable Global Interrupt
    //End enable global interrupts
}
/*--------------------------------------------------------------------------------------------------------------------*/

/*--------------------------------------------------------------------------------------------------------------------*/
/*--------------------------------------------------------------------------------------------------------------------*/
/**********************************************************************************************************************/



/***********************************************************************************************************************
; E X P O R T E D   F U N C T I O N S
;---------------------------------------------------------------------------------------------------------------------*/
//Don't use this fuction to read PROGRAM MEMORY LOCATIONS (NVMREGS = 1)

UNSIGNED_16 DrvNVM_read_config(UNSIGNED_16 address) {
    NVMADRL = (address) & 0x00FF;
    NVMADRH = (address & 0xFF00) >> 8;
    NVMCON1bits.NVMREGS = 1;
    NVMCON1bits.RD = 1;
    while (NVMCON1bits.RD);
    return ((NVMDATH << 8) | NVMDATL);

}

/*--------------------------------------------------------------------------------------------------------------------*/
void DrvNVM_write_config(UNSIGNED_16 address, UNSIGNED_16 data) {
    
    DrvNVM_erase_config(address);
    
    NVMCON1bits.WREN = 1;
    NVMCON1bits.NVMREGS = 1; //Access dia dci, config , user id etc...

    NVMADRL = (address) & 0x00FF;
    NVMADRH = (address & 0xFF00) >> 8;


    NVMCON1bits.LWLO = 0;

    NVMDATL = data & 0xFF;
    NVMDATH = (data>>8) & 0xFF;

    DrvNVM_unlock_sequence();
}

/*--------------------------------------------------------------------------------------------------------------------*/
void DrvNVM_erase_config(UNSIGNED_16 address) {
    NVMCON1bits.NVMREGS = 1; //Access dia dci, config , user id etc...  

    NVMADRL = (address) & 0x00FF;
    NVMADRH = (address & 0xFF00) >> 8;
    NVMCON1bits.FREE = 1;
    NVMCON1bits.WREN = 1;

    //Disable global interrupts                       
    INTCON &= ~INT_INTGIE; //Disable Global Interrupt
    //End disable global interrupts

    //Execute unlock sequence
    NVMCON2 = 0x55;
    NVMCON2 = 0xAA;
    NVMCON1bits.WR = 1;
    //End unlock sequence

    NVMCON1bits.WREN = 0;

    //Enable global interrupts
    INTCON |= INT_INTGIE; //Enable Global Interrupt
    //End enable global interrupts
}
/*--------------------------------------------------------------------------------------------------------------------*/

/**********************************************************************************************************************/

